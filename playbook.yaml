---
- hosts: all
  become: yes
  gather_facts: no

  tasks:

    - name: Disable system beep
      copy:
        dest: /etc/modprobe.d/nobeep.conf
        content: blacklist pcspkr

    - name: Configure Keyboard
      lineinfile:
        dest: /etc/default/keyboard
        regexp: '^XKBOPTIONS='
        #line: 'XKBOPTIONS="compose:menu,ctrl:nocaps"'
        line: 'XKBOPTIONS="compose:prsc,ctrl:nocaps"'

    - name: Add Spotify apt key
      apt_key:
        keyserver: hkp://keyserver.ubuntu.com:80
        id: BBEBDCB318AD50EC6865090613B00F1FD2C19886

    - name: Add Spotify APT repository
      apt_repository:
        repo: deb http://repository.spotify.com stable non-free
        filename: spotify

    - name: Install APT packages
      apt:
        name: "{{ item }}"
      with_lines: cat apt-packages.txt

    - name: Clone Git source
      git:
        repo: https://github.com/git/git.git
        version: v2.10.0
        dest: /opt/git
        accept_hostkey: yes

    - name: Uninstall unwanted packages
      apt:
        name: xscreensaver,xfdesktop4,git
        state: absent

    - name: Install Git dependencies
      apt:
        name: libcurl4-gnutls-dev,libexpat1-dev,gettext,libz-dev,libssl-dev,asciidoc,xmlto,docbook2x

    - name: Install Git
      shell: |
        make prefix=/usr/local doc all
        make prefix=/usr/local install install-doc
      args:
        chdir: /opt/git/

    - name: Clone RedShift source
      git:
        repo: https://github.com/jonls/redshift.git
        version: v1.11
        dest: /opt/redshift
        accept_hostkey: yes

    - name: Install RedShift dependencies
      apt:
        name: redshift
        state: build-dep

    - name: Install more RedShift dependencies
      apt:
        name: libtool,intltool

    - name: Install RedShift
      shell: |
        ./bootstrap
        ./configure
        make
        make install
      args:
        chdir: /opt/redshift/

    - name: Install Slack
      apt:
        deb: https://downloads.slack-edge.com/linux_releases/slack-desktop-2.2.1-amd64.deb

    - name: Install Ubuntu Font
      unarchive:
        remote_src: yes
        copy: no
        src: http://font.ubuntu.com/download/ubuntu-font-family-0.83.zip
        dest: /usr/share/fonts/truetype

    - name: Install Slock
      unarchive:
        remote_src: yes
        copy: no
        src: http://dl.suckless.org/tools/slock-1.3.tar.gz
        dest: /opt/

    - name: Use Slock as xflock4
      shell: |
        mv /usr/bin/xflock4 /usr/bin/xflock4.orig
        ln -s /usr/local/bin/slock /usr/bin/xflock4

    - name: PulseAudo switch-on-connect
      lineinfile:
        dest: /etc/pulse/default.pa
        insertafter: EOF
        line: load-module module-switch-on-connect


- hosts: localhost

  tasks:

    - name: Create Xfce4 autostart directory
      file:
        path: "{{ ansible_user_dir }}/.config/autostart/"
        state: directory

    - name: Make Xfce4 use Xmonad as window manager
      copy:
        dest: "{{ ansible_user_dir }}/.config/autostart/Xmonad.desktop"
        content: |
          [Desktop Entry]
          Encoding=UTF-8
          Version=0.9.4
          Type=Application
          Name=Xmonad
          Comment=
          Exec=xmonad --replace
          OnlyShowIn=XFCE;
          StartupNotify=false
          Terminal=false
          Hidden=false
